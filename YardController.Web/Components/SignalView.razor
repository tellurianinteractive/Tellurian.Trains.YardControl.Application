@using Tellurian.Trains.YardController.Model
@using Tellurian.Trains.YardController.Model.Control
@using System.Globalization

@if (Data.Coordinate.HasValue)
{
    var coord = Data.Coordinate.Value;
    var (x, y) = IsInverted
        ? ((MaxColumn - coord.Column) * CellSize, (MaxRow - coord.Row + 1) * CellSize)
        : (coord.Column * CellSize, coord.Row * CellSize);
    var facingLeft = IsInverted ? Data.DrivesRight : !Data.DrivesRight;
    var arrowPoints = facingLeft
        ? FormattableString.Invariant($"{x + 30},{y - 8} {x + 8},{y - 8} {x},{y} {x + 8},{y + 8} {x + 30},{y + 8}")
        : FormattableString.Invariant($"{x - 30},{y - 8} {x - 8},{y - 8} {x},{y} {x - 8},{y + 8} {x - 30},{y + 8}");
    var textX = facingLeft ? x + 19 : x - 19;
    var stateClass = Data.State == SignalState.Go ? "signal-go" : "signal-stop";
    var selectedClass = IsSelected ? "signal-selected" : "";

    <g class="signal @stateClass @selectedClass" id="signal-@Data.Name" @onclick="(e) => OnSignalClicked.InvokeAsync(new SignalClickEventArgs(Data.Name, e.CtrlKey, e.ShiftKey))">
        <polygon points="@arrowPoints" />
        @((MarkupString)$"""
            <text
                x="{F(textX)}"
                y="{F(y + 5)}"
                text-anchor="middle"
                fill="white"
                font-size="14"
                font-family="sans-serif"
                font-weight="bold">
                {System.Web.HttpUtility.HtmlEncode(Data.DisplayText)}
            </text>
            """)
    </g>
}

@code {
    [Parameter, EditorRequired]
    public Signal Data { get; set; } = default!;

    [Parameter]
    public int CellSize { get; set; } = 40;

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public bool IsInverted { get; set; }

    [Parameter]
    public int MaxColumn { get; set; }

    [Parameter]
    public int MaxRow { get; set; }

    [Parameter]
    public EventCallback<SignalClickEventArgs> OnSignalClicked { get; set; }

    private static string F(double value) => value.ToString("F1", CultureInfo.InvariantCulture);
}
